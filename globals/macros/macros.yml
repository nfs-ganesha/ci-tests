- scm:
    name: ci-tests
    scm:
    - git:
        branches:
        - 'refs/heads/centos-ci'
        browser: auto
        skip-tag: true
        shallow-clone: true
        url: https://github.com/nfs-ganesha/ci-tests.git 
        basedir: "$WORKSPACE/ci-tests"

- builder:
    name: get-node
    builders:
    - shell: !include-raw-verbatim: ../../build_scripts/common/get-node.sh

- property:
    name: nfs-github
    properties:
    - github:
        url: https://github.com/nfs-ganesha/nfs-ganesha/

- property:
    name: nfs-ntirpc
    properties:
    - github:
        url: https://github.com/nfs-ganesha/ntirpc/

- property:
    name: discarder
    properties:
    - build-discarder:
        days-to-keep: 14

- wrapper:
    name: ssh-agent
    wrappers:
      - ssh-agent-credentials:
          users: ''

- wrapper:
    name: cleanup-ws
    wrappers:
      - workspace-cleanup:
          include: ''

- trigger:
    name: gerrithub-trigger
    triggers:
      - gerrit:
          server-name: nfs-ganesha-gerrithub
          silent: true
          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-no-code-change: true
            - comment-added-contains-event:
                comment-contains-value: 'recheck all'
          projects:
            - project-compare-type: PLAIN
              project-pattern: 'ffilz/nfs-ganesha'
              branches:
                - branch-pattern: '**'
                  branch-compare-type: ANT

- parameter:
    name: script_variables
    parameters:
    - string:
        default: "$WORKSPACE/ci-tests/build_scripts/common/basic-gluster.sh"
        description: Test script to execute on the reserved machine acting as a server.
        name: SERVER_TEST_SCRIPT
    - string:
        default: "$WORKSPACE/ci-tests/build_scripts/common/client.sh"
        description: Test script to execute on the reserved machine acting as a client.
        name: CLIENT_TEST_SCRIPT

- parameter:
    name: nfs_variables
    parameters:
    - string:
        default: ''
        description: URL to the .repo file to use for installing NFS-Ganesha
        name: YUM_REPO
    - string:
        default: '{export_var}'
        description: 'Name of the NFS-export to create.'
        name: EXPORT

- parameter:
    name: gerrit_variables
    parameters:
    - string:
        default: 'review.gerrithub.io'
        description: 'Hostname of the Gerrit server.'
        name: GERRIT_HOST
    - string:
        default: ffilz/nfs-ganesha
        description: Project name from Gerrit (like "ffilz/nfs-ganesha").
        name: GERRIT_PROJECT
    - string:
        default: refs/heads/next
        description: Git reference to fetch from the Gerrit project.
        name: GERRIT_REFSPEC

- parameter:
    name: centos_variables
    parameters:
    - choice:
        choices:
        - "9s"
        - "8s"
        - "7"
        description: 'CentOS version to run the tests on (server + client)'
        name: CENTOS_VERSION
    - choice:
        choices:
        - x86_64
        - i386
        description: 'CentOS architecture to run the tests on (server + client)'
        name: CENTOS_ARCH

- wrapper:
    name: gerrithub_key
    wrappers:
    - credentials-binding:
         - file:
            credential-id: GERRITHUB_PRIVATE_KEY
            variable: GERRITHUB_KEY

- wrapper:
    name: aws_credentials
    wrappers:
    - credentials-binding:
         - text:
            credential-id: AWS_ACCESS_KEY
            variable: ACCESS_KEY
         - text:
            credential-id: AWS_SECRET_KEY
            variable: SECRET_KEY

#Enable this to over-ride the configuration under Manage Jenkins > Configure System >  Global Build Time Out 
#This one is meant for pynfs jobs, setting the value to 4 hours as a part of my testing!
- wrapper:
    name: terminate_stuck_build
    wrappers:
    - timeout:
        timeout: 240
        abort: true
        type: no-activity

- publisher:
    name: post_build_task_return-node
    publishers:
    - post-tasks:
        - matches:
            - log-text: Building remotely
              operator: OR
            - log-text: Build step 'Execute shell' marked build as failure
              operator: OR
            - log-text: Build was aborted
              operator: OR
          script:
            !include-raw-verbatim: ../../build_scripts/common/return-node.sh

- publisher:
    name: archive_artifacts
    publishers:
    - archive:
        artifacts: '*.log'
        allow-empty: true
        only-if-success: false 
        fingerprint: true
        excludes: path
